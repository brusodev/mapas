<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Grupos SP - Vers√£o Local</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #map {
      height: 100vh;
      width: 100%;
    }

    .legend {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 320px;
      max-height: 70vh;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      padding: 20px;
      z-index: 1000;
      overflow-y: auto;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .legend h3 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 18px;
      font-weight: 600;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s ease;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .legend-item:hover {
      background-color: rgba(0, 0, 0, 0.05);
      transform: translateX(5px);
    }

    .legend-item.active {
      border-color: #333;
      background-color: rgba(0, 0, 0, 0.08);
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 12px;
      border: 2px solid #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .legend-text {
      flex: 1;
    }

    .legend-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 2px;
    }

    .legend-value {
      font-size: 12px;
      color: #666;
    }

    .controls {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      border: 1px solid rgba(0, 0, 0, 0.1);
      min-width: 250px;
    }

    .controls h4 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 14px;
    }

    .controls select,
    .controls input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .controls button {
      width: 100%;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: #3498db;
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 5px;
    }

    .controls button:hover {
      background: #2980b9;
    }

    .controls button.secondary {
      background: #95a5a6;
    }

    .controls button.secondary:hover {
      background: #7f8c8d;
    }

    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 10px;
      z-index: 2000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      text-align: center;
    }

    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .status {
      font-size: 12px;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
    }

    .error {
      color: #e74c3c;
      background: #fdf2f2;
      border: 1px solid #f5c6cb;
    }

    .success {
      color: #27ae60;
      background: #f2f9f2;
      border: 1px solid #c3e6cb;
    }

    .warning {
      color: #f39c12;
      background: #fef9e7;
      border: 1px solid #faeaa3;
    }

    .file-input-area {
      border: 2px dashed #ddd;
      padding: 20px;
      text-align: center;
      border-radius: 8px;
      margin: 10px 0;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .file-input-area:hover {
      border-color: #3498db;
    }

    .file-input-area.dragover {
      border-color: #27ae60;
      background: #f2f9f2;
    }

    #diagnostic {
      max-height: 200px;
      overflow-y: auto;
      font-size: 11px;
      line-height: 1.3;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <div id="loading-text">Inicializando mapa...</div>
  </div>

  <div class="legend" id="legend">
    <h3>Grupos e Valores</h3>
    <div id="legend-content"></div>
  </div>

  <div class="controls">
    <h4>Controles do Mapa</h4>

    <select id="groupSelect">
      <option value="">üåç Mostrar todos os grupos</option>
    </select>

    <button onclick="showAllGroups()">üîÑ Resetar Visualiza√ß√£o</button>
    <button onclick="togglePins()">üìç Mostrar/Ocultar Alfinetes</button>

    <hr style="margin: 15px 0; border: none; border-top: 1px solid #eee;">

    <h4>Carregar Coordenadas</h4>
    <div class="file-input-area" onclick="document.getElementById('fileInput').click()">
      üìÅ Clique para selecionar coordenadas_completa.js<br>
      <small>ou arraste o arquivo aqui</small>
    </div>
    <input type="file" id="fileInput" accept=".js" style="display: none;">

    <button onclick="loadFromURL()" class="secondary">üåê Carregar de URL</button>
    <input type="text" id="urlInput" placeholder="URL do arquivo .js" style="display: none;">

    <button onclick="runDiagnostic()" class="secondary">üîß Diagn√≥stico</button>

    <div id="status"></div>
    <div id="diagnostic"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

  <script>
    // Dados dos grupos
    const grupos = {
      "GRUPO 01": ["CENTRO SUL", "LESTE 4", "SUL 1", "NORTE 2", "LESTE 3", "LESTE 1", "NORTE 1", "LESTE 5", "CENTRO OESTE", "LESTE 2", "SUL 2", "CENTRO", "SUL 3", "GUARULHOS NORTE", "GUARULHOS SUL", "ITAQUAQUECETUBA", "MOGI DAS CRUZES", "SUZANO", "DIADEMA", "MAU√Å", "SANTO ANDR√â", "S√ÉO BERNARDO DO CAMPO"],
      "GRUPO 02": ["CAIEIRAS", "CARAPICU√çBA", "ITAPECERICA DA SERRA", "ITAPEVI", "OSASCO", "TABO√ÉO DA SERRA"],
      "GRUPO 03": ["ANDRADINA", "ARA√áATUBA", "BIRIGUI", "FERNAND√ìP√ìLIS", "JALES", "PEN√ÅPOLIS", "VOTUPORANGA"],
      "GRUPO 04": ["ARARAQUARA", "FRANCA", "JABOTICABAL", "PIRASSUNUNGA", "RIBEIR√ÉO PRETO", "S√ÉO CARLOS", "S√ÉO JOAQUIM DA BARRA", "SERT√ÉOZINHO"],
      "GRUPO 05": ["ADAMANTINA", "ASSIS", "MIRANTE DO PARANAPANEMA", "OURINHOS", "PRESIDENTE PRUDENTE", "SANTO ANAST√ÅCIO", "TUP√É"],
      "GRUPO 06": ["APIAI", "ITAPETININGA", "ITAPEVA", "ITARAR√â", "ITU", "S√ÉO ROQUE", "SOROCABA", "VOTORANTIM"],
      "GRUPO 07": ["BRAGANCA PAULISTA", "CAMPINAS LESTE", "CAMPINAS OESTE", "JUNDIAI", "MOGI MIRIM", "S√ÉO JO√ÉO DA BOA VISTA"],
      "GRUPO 08": ["MIRACATU", "REGISTRO", "SANTOS", "S√ÉO VICENTE"],
      "GRUPO 09": ["CARAGUATATUBA", "GUARATINGUETA", "JACAREI", "PINDAMONHANGABA", "SAO JOSE DOS CAMPOS", "TAUBATE"],
      "GRUPO 10": ["BARRETOS", "CATANDUVA", "JOS√â BONIFACIO", "S√ÉO JOS√â DO RIO PRETO", "TAQUARITINGA"],
      "GRUPO 11": ["AVAR√â", "BAURU", "BOTUCATU", "JAU", "LINS", "MARILIA", "PIRAJU"],
      "GRUPO 12": ["AMERICANA", "CAPIVARI", "LIMEIRA", "PIRACICABA", "SUMAR√â"]
    };

    // Paleta de cores para os grupos
    const groupColors = {
      "GRUPO 01": "#e74c3c", "GRUPO 02": "#3498db", "GRUPO 03": "#2ecc71", "GRUPO 04": "#9b59b6",
      "GRUPO 05": "#f39c12", "GRUPO 06": "#1abc9c", "GRUPO 07": "#34495e", "GRUPO 08": "#e67e22",
      "GRUPO 09": "#95a5a6", "GRUPO 10": "#8e44ad", "GRUPO 11": "#27ae60", "GRUPO 12": "#2980b9"
    };

    // Vari√°veis globais
    let map, citiesLayer = null, markersLayer = null, nameToGroup = {}, selectedGroup = null, pinsVisible = true;

    // Fun√ß√£o para normalizar nomes
    function normalizeName(name) {
      if (!name) return '';
      return name.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toUpperCase().trim().replace(/\s+/g, ' ');
    }

    // Criar mapeamento nome-grupo
    function createNameToGroupMap() {
      const mapping = {};
      for (const [groupName, cities] of Object.entries(grupos)) {
        for (const city of cities) {
          const normalizedName = normalizeName(city);
          mapping[normalizedName] = groupName;
        }
      }
      return mapping;
    }

    // Fun√ß√£o para encontrar grupo da cidade
    function findCityGroup(feature) {
      const possibleNames = [
        feature.properties?.name, feature.properties?.NOME, feature.properties?.cidade,
        feature.properties?.CIDADE, feature.properties?.municipio, feature.properties?.MUNICIPIO,
        feature.properties?.description, feature.properties?.id
      ].filter(Boolean);

      for (const name of possibleNames) {
        const normalized = normalizeName(name);
        if (nameToGroup[normalized]) {
          return nameToGroup[normalized];
        }

        // Busca fuzzy
        for (const [groupName, cities] of Object.entries(grupos)) {
          for (const city of cities) {
            const normalizedCity = normalizeName(city);
            if (normalizedCity.includes(normalized) || normalized.includes(normalizedCity) ||
              normalizedCity.replace(/\s+/g, '') === normalized.replace(/\s+/g, '')) {
              console.log(`üîç Match: "${name}" -> "${city}" (${groupName})`);
              return groupName;
            }
          }
        }
      }
      return null;
    }

    // Calcular centroide
    function calculateCentroid(coordinates) {
      let x = 0, y = 0, points = 0;

      function processCoords(coords) {
        if (Array.isArray(coords[0]) && Array.isArray(coords[0][0])) {
          coords.forEach(ring => processCoords(ring));
        } else if (Array.isArray(coords[0])) {
          coords.forEach(coord => {
            if (coord.length >= 2) {
              x += coord[0]; y += coord[1]; points++;
            }
          });
        }
      }

      processCoords(coordinates);
      return points > 0 ? [y / points, x / points] : [0, 0];
    }

    // Estilizar features
    function styleFeature(feature) {
      const group = findCityGroup(feature);
      const color = groupColors[group] || '#cccccc';
      const isSelected = selectedGroup && group === selectedGroup;

      return {
        fillColor: color, weight: isSelected ? 2 : 1, opacity: isSelected ? 1 : 0.8,
        color: '#ffffff', fillOpacity: isSelected ? 0.8 : (group ? 0.6 : 0.3)
      };
    }

    // Criar popup para cada feature
    function onEachFeature(feature, layer) {
      const possibleNames = [feature.properties?.name, feature.properties?.NOME, feature.properties?.description].filter(Boolean);
      const cityName = possibleNames[0] || 'Nome n√£o encontrado';
      const group = findCityGroup(feature);
      const color = groupColors[group] || '#cccccc';

      const popupContent = `
                <div style="font-family: Arial, sans-serif; min-width: 200px;">
                    <h4 style="margin: 0 0 10px 0; color: ${color}; border-bottom: 2px solid ${color}; padding-bottom: 5px;">
                        ${cityName}
                    </h4>
                    <p style="margin: 5px 0; color: #333;"><strong>Grupo:</strong> ${group || 'N√£o classificado'}</p>
                    <p style="margin: 5px 0; color: #666;"><strong>Valor 30 meses:</strong> R$ 12.830.960,26</p>
                    <p style="margin: 5px 0; color: #666;"><strong>Valor mensal:</strong> R$ 427.698,68</p>
                </div>
            `;

      layer.bindPopup(popupContent);

      layer.on({
        mouseover: function (e) {
          e.target.setStyle({ weight: 3, fillOpacity: 0.9 });
        },
        mouseout: function (e) {
          if (citiesLayer) citiesLayer.resetStyle(e.target);
        },
        click: function (e) {
          const group = findCityGroup(e.target.feature);
          if (group) {
            highlightGroup(group);
            document.getElementById('groupSelect').value = group;
            updateLegendSelection(group);
          }
        }
      });
    }

    // Processar dados GeoJSON
    function processGeoData(geoData) {
      updateLoadingText('Criando camadas...');

      let processedFeatures = 0, groupedFeatures = 0;

      geoData.features.forEach(feature => {
        const group = findCityGroup(feature);
        feature.properties.group = group;
        processedFeatures++;
        if (group) groupedFeatures++;
      });

      console.log(`üìä Processadas ${processedFeatures} features, ${groupedFeatures} classificadas`);

      // Criar camada de cidades
      citiesLayer = L.geoJSON(geoData, {
        style: styleFeature,
        onEachFeature: onEachFeature
      });

      // Criar markers dos grupos
      createGroupMarkers(geoData);

      return citiesLayer;
    }

    // Criar markers dos grupos
    function createGroupMarkers(geoData) {
      const groupCentroids = {}, groupFeatures = {};

      geoData.features.forEach(feature => {
        const group = feature.properties.group;
        if (group) {
          if (!groupFeatures[group]) groupFeatures[group] = [];
          groupFeatures[group].push(feature);
        }
      });

      Object.entries(groupFeatures).forEach(([group, features]) => {
        let totalX = 0, totalY = 0, totalPoints = 0;

        features.forEach(feature => {
          const centroid = calculateCentroid(feature.geometry.coordinates);
          totalX += centroid[1]; totalY += centroid[0]; totalPoints++;
        });

        if (totalPoints > 0) {
          groupCentroids[group] = [totalY / totalPoints, totalX / totalPoints];
        }
      });

      markersLayer = L.layerGroup();

      Object.entries(groupCentroids).forEach(([group, coords]) => {
        const color = groupColors[group] || '#cccccc';
        const citiesCount = grupos[group] ? grupos[group].length : 0;

        const pinIcon = L.divIcon({
          className: 'custom-pin',
          html: `
                        <div style="background: ${color}; width: 30px; height: 30px; border-radius: 50% 50% 50% 0;
                                    border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                                    transform: rotate(-45deg); display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-weight: bold; font-size: 12px; transform: rotate(45deg);">
                                ${group.split(' ')[1]}
                            </span>
                        </div>
                    `,
          iconSize: [30, 30], iconAnchor: [15, 30]
        });

        const marker = L.marker(coords, { icon: pinIcon });

        marker.bindPopup(`
                    <div style="text-align: center; font-family: Arial, sans-serif;">
                        <h3 style="margin: 0 0 10px 0; color: ${color};">${group}</h3>
                        <p style="margin: 5px 0; color: #333;"><strong>${citiesCount} cidades</strong></p>
                        <p style="margin: 5px 0; color: #666;">R$ 12.830.960,26</p>
                    </div>
                `);

        marker.on('click', () => {
          highlightGroup(group);
          document.getElementById('groupSelect').value = group;
          updateLegendSelection(group);
        });

        markersLayer.addLayer(marker);
      });

      console.log(`üìç Criados ${Object.keys(groupCentroids).length} alfinetes`);
    }

    // Destacar grupo
    function highlightGroup(groupName) {
      selectedGroup = groupName;
      if (!citiesLayer) return;

      citiesLayer.eachLayer(layer => citiesLayer.resetStyle(layer));

      const groupLayers = [];
      citiesLayer.eachLayer(layer => {
        if (layer.feature.properties.group === groupName) {
          groupLayers.push(layer);
        }
      });

      if (groupLayers.length > 0) {
        const group = new L.featureGroup(groupLayers);
        map.fitBounds(group.getBounds(), { padding: [50, 50] });
      }

      updateLegendSelection(groupName);
      showStatus(`Grupo ${groupName} destacado (${groupLayers.length} cidades)`);
    }

    // Mostrar todos os grupos
    function showAllGroups() {
      selectedGroup = null;
      document.getElementById('groupSelect').value = '';

      if (citiesLayer) {
        citiesLayer.eachLayer(layer => citiesLayer.resetStyle(layer));
        map.fitBounds(citiesLayer.getBounds(), { padding: [20, 20] });
      }

      updateLegendSelection(null);
      showStatus('Mostrando todos os grupos');
    }

    // Alternar alfinetes
    function togglePins() {
      if (!markersLayer) return;

      if (pinsVisible) {
        map.removeLayer(markersLayer);
        pinsVisible = false;
        showStatus('Alfinetes ocultados');
      } else {
        map.addLayer(markersLayer);
        pinsVisible = true;
        showStatus('Alfinetes exibidos');
      }
    }

    // Criar legenda
    function createLegenda() {
      const legendContent = document.getElementById('legend-content');
      legendContent.innerHTML = '';

      Object.entries(grupos).forEach(([groupName, cities]) => {
        const color = groupColors[groupName];
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.dataset.group = groupName;

        item.innerHTML = `
                    <div class="legend-color" style="background-color: ${color};"></div>
                    <div class="legend-text">
                        <div class="legend-title">${groupName}</div>
                        <div class="legend-value">${cities.length} cidades ‚Ä¢ R$ 12.830.960,26</div>
                    </div>
                `;

        item.addEventListener('click', () => {
          highlightGroup(groupName);
          document.getElementById('groupSelect').value = groupName;
        });

        legendContent.appendChild(item);
      });
    }

    // Atualizar sele√ß√£o da legenda
    function updateLegendSelection(groupName) {
      document.querySelectorAll('.legend-item').forEach(item => {
        item.classList.remove('active');
        if (groupName && item.dataset.group === groupName) {
          item.classList.add('active');
        }
      });
    }

    // Criar seletor de grupos
    function createGroupSelector() {
      const select = document.getElementById('groupSelect');

      Object.keys(grupos).forEach(groupName => {
        const option = document.createElement('option');
        option.value = groupName;
        option.textContent = `${groupName} (${grupos[groupName].length} cidades)`;
        select.appendChild(option);
      });

      select.addEventListener('change', function () {
        const selectedGroup = this.value;
        if (selectedGroup) {
          highlightGroup(selectedGroup);
        } else {
          showAllGroups();
        }
      });
    }

    // Utilit√°rios de interface
    function updateLoadingText(text) {
      document.getElementById('loading-text').textContent = text;
    }

    function showStatus(message, type = 'success') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
      setTimeout(() => statusDiv.innerHTML = '', 3000);
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    // Carregar arquivo selecionado
    function loadFileFromInput(file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          let content = e.target.result;
          console.log('üìÑ Arquivo carregado:', file.name, content.length, 'caracteres');

          // Processar conte√∫do
          if (content.includes('export function')) {
            content = content.replace('export function', 'window.mapasp_completo = function');
          }

          eval(content);

          if (typeof window.mapasp_completo === 'function') {
            const geoData = window.mapasp_completo();
            loadGeoData(geoData);
            showStatus(`‚úÖ Arquivo ${file.name} carregado com sucesso!`);
          } else {
            throw new Error('Fun√ß√£o mapasp_completo n√£o encontrada');
          }
        } catch (error) {
          console.error('‚ùå Erro ao processar arquivo:', error);
          showStatus(`‚ùå Erro ao carregar arquivo: ${error.message}`, 'error');
        }
      };
      reader.readAsText(file);
    }

    // Carregar dados no mapa
    function loadGeoData(geoData) {
      if (!geoData || !geoData.features) {
        throw new Error('Dados GeoJSON inv√°lidos');
      }

      updateLoadingText('Processando dados...');

      // Remover camadas existentes
      if (citiesLayer) map.removeLayer(citiesLayer);
      if (markersLayer) map.removeLayer(markersLayer);

      // Processar e adicionar novas camadas
      const cities = processGeoData(geoData);
      cities.addTo(map);
      markersLayer.addTo(map);

      // Ajustar zoom
      map.fitBounds(cities.getBounds(), { padding: [20, 20] });

      hideLoading();
      showStatus(`‚úÖ ${geoData.features.length} munic√≠pios carregados!`);
    }

    // Carregar de URL
    function loadFromURL() {
      const urlInput = document.getElementById('urlInput');
      if (urlInput.style.display === 'none') {
        urlInput.style.display = 'block';
        urlInput.focus();
        return;
      }

      const url = urlInput.value.trim();
      if (!url) {
        showStatus('‚ùå Digite uma URL v√°lida', 'error');
        return;
      }

      updateLoadingText('Carregando de URL...');

      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response.text();
        })
        .then(content => {
          if (content.includes('export function')) {
            content = content.replace('export function', 'window.mapasp_completo = function');
          }

          eval(content);

          if (typeof window.mapasp_completo === 'function') {
            const geoData = window.mapasp_completo();
            loadGeoData(geoData);
          } else {
            throw new Error('Fun√ß√£o mapasp_completo n√£o encontrada');
          }
        })
        .catch(error => {
          hideLoading();
          showStatus(`‚ùå Erro ao carregar de URL: ${error.message}`, 'error');
        });
    }

    // Diagn√≥stico
    function runDiagnostic() {
      const diagnosticDiv = document.getElementById('diagnostic');
      diagnosticDiv.innerHTML = '<strong>üîß Executando diagn√≥stico...</strong><br>';

      const log = (message) => {
        diagnosticDiv.innerHTML += message + '<br>';
        console.log(message);
      };

      log(`üìç Localiza√ß√£o: